<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright 2011 . All rights reserved.
     Author: AlexBuzunov@gmail.com (Alex Buzunov)
     Python Implementation of ETL pipeline
-->
<etldataflow name="SMC_SPOOL">
<globals>

	<!-- PIPELINE execution type
		 SYNC - synchronous, ANYNC - asynchronous 
	-->
	  <param name="FLOW_TYPE" value="SYNC"></param>	

	  <param name="FIELD_TERMINATOR" value="|"></param>
	  <param name="LINE_TERMINATOR" value="''"></param>
	  
  
	  <param name="FROM_DB" value="%DL_GMAU%"></param>
	  <param name="FROM_DB1" value="%AB_SMARTP1B%"></param>
	  <param name="FROM_SCHEMA" value="DLROGMARWSMART"></param>
	  <param name="DB_CONNECTOR1" value="%DL_GMAU%"></param>
	  
	  
	   <!--will spool ALL records if LAME_DUCK=0-->
	  <param name="LAME_DUCK" value='0'></param>
	  <param name="ARRAYSIZE" value="5000"></param>
	  <param name="COPYCOMMIT" value="4"></param>
	  <!--sqlp attribute-->
		
		
	  <param name="SOURCE_FILE" value="--replaced from command line"></param>	
	  <param name="COB_YEAR" value="--replaced from command line"></param>

</globals>

	
<worker name="SMC_3t">
  <exec_query_spool>
    <table_utils 	method="%QUERY_SPOOL_METHOD%" >
     	<param name="IF_COMPRESSED_SPOOL" value="0"></param>
		<param name="DB_CONNECTOR" value="%CSMARTREF_SMARTQ1%"></param>
		<param name="FROM_DB" value="%AB_SMARTCOB%"></param>
		<param name="SCHEMA_NAME" value="CSMARTREF"></param>
      <sql_template>
        <![CDATA[ 
SELECT --+parallel(F) 
  F.TD_AGE,
  F.TD_AGE_BND_1,
  F.TRADE_DATE,
  F.RISK_PF_IND,
  F.VLD_OWN_CD,
  F.VLD_PF,
  F.VLD_STA,
  Table__282.LVL_4_OWN,
  Table__282.LVL_3_OWN,
  Table__282.LVL_2_OWN,
  F.SOURCESYSTEM,
  nvl(F.CUSIP_CODE,'UNALLOCATED') aa,
  F.ISIN_CODE,
  F.INTERNAL_PRODUCT_ID,
  nvl(F.INTERNAL_PRODUCT_DESCRIPTION,'UNALLOCATED') INTERNAL_PRODUCT_DESCRIPTION,
  F.PRE_SETL_EVNT_TYP,
  F.PRE_SETL_AGE_BND_1,
  F.TRANSACTION_TYPE,
  F.COB_DATE,
  F.BUYIN_DUE_DT,
  F.SECURITY_MATURITY_DATE,
  F.AGE_BUSINESS_DAYS,
  F.SETTLEMENT_DATE_CONTRACTUAL,
  F.SETTLEMENT_CURRENCY,
  SUM(F.AMOUNT_REMAINING_SETT_CCY) s1,
  Sum(F.AMOUNT_REMAINING_CAL_USD) s2,
  Sum(F.QUANTITY_REMAINING) s3,
  sum(F.QUANTITY_CONTRACTUAL) s4,
  Sum(F.PRICE) s5,
  Sum(F.TRADE_VALUE_USD) s6,
  Sum(F.MTM_TRADE_VALUE_USD) s7,
  nvl(F.COUNTERPARTY_NAME,'UNALLOCATED') s8,
  nvl(F.COUNTERPARTY_MNEMONIC,'UNALLOCATED') s9,
  nvl(F.COUNTERPARTY_PARENT_NAME,'UNALLOCATED') s10,
  nvl(F.FIRM_ACCOUNT,'UNALLOCATED') jj,
  F.FIRM_MNEMONIC,
  F.EXEC_TYP,
  initcap(F.BUY_SELL) BUY_SELL,
  PEARL_VIA_FA.GOC_RGN_DESCR,
  F.SETTLEMENT_LOCATION,
  F.PROC_COD,
  F.STGY_CD,
  F.TRADER_ID,
  F.TRADER_NAME,
  F.SALESPERSON_NAME,
  nvl(F.SALESPERSON_ID, 'UNALLOCATED') rr,
  F.NORM_INSR_STA,
  F.NORM_MTCH_STA,
  F.LEGAL_ENTITY_ID,
  F.LEGAL_ENTITY_NAME,
  MAN_REF_ASET_LVL_DATA.ASET_LVL_0_DESC,
  MAN_REF_ASET_LVL_DATA.ASET_LVL_1_DESC,
  MAN_REF_ASET_LVL_DATA.ASET_LVL_2_DESC,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_2_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_7_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_8_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_9_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_10_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_11_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_12_DESCR,
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_13_DESCR,
  F.INTERCMPY_RECON_MATCH_STA,
  F.INTERCMPY_MATCH_ID,
  F.INTERCO_REC_SOURCE_DUP_MTCH_ID,
  F.AFRM_IND_2,
  F.AFRM_IND_REF_2,
  count(F.SYSTEM_ID||F.UNIQUE_ID) UNIQUE_ID_1,
  F.IRIS_VLD_STA,
  Table__282.LVL_8_OWN,
  Table__282.LVL_7_OWN,
  Table__282.LVL_6_OWN,
  Table__282.LVL_5_OWN,
  F.BLOTTER_CODE,
  F.AFFIRMATION_IND_SNACC,
  F.AFFIRMATION_IND_SNACC_REF,
  F.AFFIRMATION_IND_TPS_STP_REF,
  F.AFFIRMATION_INDICATOR_TPS_STP
FROM
  (                                                                                                             
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_CLU) t UNION ALL           
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_ATLAS) t UNION ALL         
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_DOGS) t UNION ALL          
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_KOSMOS) t UNION ALL        
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_MATCHBOOK) t UNION ALL     
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_COPES_TH) t UNION ALL      
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_COPES_SG) t UNION ALL      
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_GCS) t UNION ALL           
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_RADAR) t UNION ALL         
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_CTS) t UNION ALL           
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_IOWA) t UNION ALL          
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_GSR_EXCEPTIONS) t UNION ALL
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_BROADRIDGE) t UNION ALL    
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_SMS) t UNION ALL           
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_RTGSA) t UNION ALL         
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_IBROKER) t UNION ALL       
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_NEWASKA) t UNION ALL       
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_QUANTUM) t UNION ALL       
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_NOVA) t UNION ALL          
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_S21) t UNION ALL           
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_SOPHIA) t UNION ALL        
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_SONOMA) t UNION ALL        
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_IOWAAU) t UNION ALL        
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_POWERBASE) t UNION ALL     
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_FLEXCUBE_PP_FI) t UNION ALL
select /*+FULL(t) */ t.* from csmartbser.FAILS_REPORTS_HISTORY SUBPARTITION(P20130322_P_DEFAULT) t               
) F ,
  csmartref.MAN_REF_OPS_OWN_HIER  Table__282,
  csmartref.REF_MNGD_SEG_HIER  PEARL_VIA_FA,
  csmartref.MAN_REF_ASET_LVL_DATA,
  csmartref.REF_MNGD_SEG_HIER,
  ( 
  SELECT /*+FULL(REF_MNGD_SEG_XREF)*/ REF_MNGD_SEG_XREF.FIRM_ACCT AS FIRM_ACCOUNT, REF_MNGD_SEG_XREF.FIRM_ACCT_MNEMONIC AS FIRM_MNEMONIC, REF_MNGD_SEG_XREF.MAPNG_TRCK AS TRACK_NUMBER, REF_MNGD_SEG_XREF.STGY_CD AS STRAT_CODE, REF_MNGD_SEG_XREF.GOC AS GOC
FROM csmartref.REF_MNGD_SEG_XREF
WHERE REF_MNGD_SEG_XREF.GOC IS NOT NULL AND REF_MNGD_SEG_XREF.FIRM_ACCT IS NOT NULL AND REF_MNGD_SEG_XREF.MAPNG_TRCK in( 'Track 1','Track 2','Track 6')
  )  PEARL_FA_GOC_MAPPING
WHERE
  ( MAN_REF_ASET_LVL_DATA.ASET_LVL_KEY(+)=F.ASET_CLAS_KEY  )
  AND  ( F.FO_KEY=REF_MNGD_SEG_HIER.GOC(+)  )
  AND  ( PEARL_FA_GOC_MAPPING.GOC=PEARL_VIA_FA.GOC(+)  )
  AND  ( F.FIRM_ACCOUNT=PEARL_FA_GOC_MAPPING.FIRM_ACCOUNT(+)  )
  AND  ( F.VLD_OWN_CD=Table__282.OWN_CD(+)  )
  AND  
  (
   F.COB_DATE  IN  ( '22-MAR-2013'  )
   AND
   F.EST_EVENT_TYPE  IN  ( 'Open Trade','Extended Settlement Trade'  )
  )
GROUP BY
  F.TD_AGE, 
  F.TD_AGE_BND_1, 
  F.TRADE_DATE, 
  F.RISK_PF_IND, 
  F.VLD_OWN_CD, 
  F.VLD_PF, 
  F.VLD_STA, 
  Table__282.LVL_4_OWN, 
  Table__282.LVL_3_OWN, 
  Table__282.LVL_2_OWN, 
  F.SOURCESYSTEM, 
  nvl(F.CUSIP_CODE,'UNALLOCATED'), 
  F.ISIN_CODE, 
  F.INTERNAL_PRODUCT_ID, 
  nvl(F.INTERNAL_PRODUCT_DESCRIPTION,'UNALLOCATED'), 
  F.PRE_SETL_EVNT_TYP, 
  F.PRE_SETL_AGE_BND_1, 
  F.TRANSACTION_TYPE, 
  F.COB_DATE, 
  F.BUYIN_DUE_DT, 
  F.SECURITY_MATURITY_DATE, 
  F.AGE_BUSINESS_DAYS, 
  F.SETTLEMENT_DATE_CONTRACTUAL, 
  F.SETTLEMENT_CURRENCY, 
  nvl(F.COUNTERPARTY_NAME,'UNALLOCATED'), 
  nvl(F.COUNTERPARTY_MNEMONIC,'UNALLOCATED'), 
  nvl(F.COUNTERPARTY_PARENT_NAME,'UNALLOCATED'), 
  nvl(F.FIRM_ACCOUNT,'UNALLOCATED'), 
  F.FIRM_MNEMONIC , 
  F.EXEC_TYP, 
  initcap(F.BUY_SELL), 
  PEARL_VIA_FA.GOC_RGN_DESCR, 
  F.SETTLEMENT_LOCATION, 
  F.PROC_COD, 
  F.STGY_CD, 
  F.TRADER_ID, 
  F.TRADER_NAME, 
  F.SALESPERSON_NAME, 
  nvl(F.SALESPERSON_ID, 'UNALLOCATED'), 
  F.NORM_INSR_STA, 
  F.NORM_MTCH_STA, 
  F.LEGAL_ENTITY_ID, 
  F.LEGAL_ENTITY_NAME, 
  MAN_REF_ASET_LVL_DATA.ASET_LVL_0_DESC, 
  MAN_REF_ASET_LVL_DATA.ASET_LVL_1_DESC, 
  MAN_REF_ASET_LVL_DATA.ASET_LVL_2_DESC, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_2_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_7_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_8_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_9_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_10_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_11_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_12_DESCR, 
  REF_MNGD_SEG_HIER.MNGD_SEG_LVL_13_DESCR, 
  F.INTERCMPY_RECON_MATCH_STA, 
  F.INTERCMPY_MATCH_ID, 
  F.INTERCO_REC_SOURCE_DUP_MTCH_ID, 
  F.AFRM_IND_2, 
  F.AFRM_IND_REF_2, 
  F.IRIS_VLD_STA, 
  Table__282.LVL_8_OWN, 
  Table__282.LVL_7_OWN, 
  Table__282.LVL_6_OWN, 
  Table__282.LVL_5_OWN, 
  F.BLOTTER_CODE, 
  F.AFFIRMATION_IND_SNACC, 
  F.AFFIRMATION_IND_SNACC_REF, 
  F.AFFIRMATION_IND_TPS_STP_REF, 
  F.AFFIRMATION_INDICATOR_TPS_STP
 ;
]]>
      </sql_template>
    </table_utils>
  </exec_query_spool>
</worker >

</etldataflow>
