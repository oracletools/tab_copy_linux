<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright 2011 . All rights reserved.
     Author: AlexBuzunov@gmail.com (Alex Buzunov)
     Python Implementation of ETL pipeline
-->
<etldataflow name="Q_COPY2_TEST">
<globals> 
 
	<!-- PIPELINE execution type
		 SYNC - synchronous, ANYNC - asynchronous 
	-->
	  <param name="FLOW_TYPE" value="ASYNC"></param>	

	  <param name="FIELD_TERMINATOR" value="`|"></param>
	  <param name="LINE_TERMINATOR" value="~"></param>
	  
  
	  <param name="FROM_DB" value="%AB_SMARTP_B%"></param>
	  <param name="FROM_SCHEMA" value="CSMARTVOL"></param>
	  
	  <param name="TO_DB" value="%CVOL_SMARTU1B%"></param>
	  <param name="TO_SCHEMA" value="CSMARTVOL"></param>	  
	  
	   <!--will spool ALL records if LAME_DUCK=0-->
	  <param name="LAME_DUCK" value='0'></param>
	  <param name="ARRAYSIZE" value="5000"></param>
	  <param name="COPYCOMMIT" value="4"></param>
	  <!--sqlp attribute-->

	  <param name="IF_TRUNCATE" value="0"></param>
	  
	  <param name="IF_SHOW_SERVEROUTPUT" value="1"></param>
</globals>


<worker name="Q">
  <exec_query_copy>
    <table_utils 	method="%QUERY_COPY_METHOD%" >
	<param name="TO_TABLE" value="BO_DATA_EXPORT"></param>	
	<param name="IF_CREATE_TARGET_TABLE" value="1"></param>		 
      <sql_template>
        <![CDATA[
SELECT --+parallel
  CSMARTBSER.FAILS_REPORTS.VALIDATION_SOURCE,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_NAME,'UNALLOCATED') COUNTERPARTY_NAME,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_MNEMONIC,'UNALLOCATED') COUNTERPARTY_MNEMONIC,
  SUM(CSMARTBSER.FAILS_REPORTS.AMOUNT_REMAINING_CAL_USD) AMOUNT_REMAINING_CAL_USD,
  CSMARTBSER.FAILS_REPORTS.SETTLEMENT_CURRENCY,
  SUM(CSMARTBSER.FAILS_REPORTS.AMOUNT_REMAINING_SETT_CCY) AMOUNT_REMAINING_SETT_CCY,
  CSMARTBSER.FAILS_REPORTS.TRADE_DATE,
  CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL,
  CSMARTBSER.FAILS_REPORTS.BUY_SELL,
  CSMARTBSER.FAILS_REPORTS.LEGAL_ENTITY_NAME,
  nvl(CSMARTBSER.FAILS_REPORTS.INTERNAL_PRODUCT_DESCRIPTION,'UNALLOCATED') INTERNAL_PRODUCT_DESCRIPTION,
  CSMARTBSER.FAILS_REPORTS.SETTLEMENT_LOCATION,
  CSMARTBSER.FAILS_REPORTS.ADDITIONAL_TRADE_REF,
  CSMARTBSER.FAILS_REPORTS.OPS_SETTLEMENT_TRADE_REF,
  CSMARTBSER.FAILS_REPORTS.OPERATIONS_TRADE_REF,
  CSMARTBSER.FAILS_REPORTS.ISIN_CODE,
  nvl(CSMARTBSER.FAILS_REPORTS.CUSIP_CODE,'UNALLOCATED') CUSIP_CODE,
  CSMARTREF.REF_SLSPRSN_HIER.EMP_NAM,
  CSMARTREF.REF_SLSPRSN_HIER.SLSPRSN_TRDR_NO,
  CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM,
  CSMARTBSER.FAILS_REPORTS.AGE,
  CSMARTBSER.FAILS_REPORTS.AGE_BAND,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_5_LOCA, 'UNALLOCATED') LVL_5_LOCA,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_5_OWN, 'UNALLOCATED') LVL_5_OWN,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_4_OWN, 'UNALLOCATED') LVL_4_OWN,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_3_GRP, 'UNALLOCATED') LVL_3_GRP,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_3_OWN, 'UNALLOCATED') LVL_3_OWN,
  sum(CSMARTBSER.FAILS_REPORTS.QUANTITY_REMAINING) QUANTITY_REMAINING,
  sum(CSMARTBSER.FAILS_REPORTS.PRICE) PRICE,
  sum(CSMARTBSER.FAILS_REPORTS.MTM_PRICE_USD) MTM_PRICE_USD,
  sum(CSMARTBSER.FAILS_REPORTS.TRADE_PRICE_USD) TRADE_PRICE_USD,
  CSMARTBSER.FAILS_REPORTS.MTM_RISK,
  sum(CSMARTBSER.FAILS_REPORTS.MTM_TRADE_VALUE_USD) MTM_TRADE_VALUE_USD,
  Sum(CSMARTBSER.FAILS_REPORTS.TRADE_VALUE_USD) TRADE_VALUE_USD,
  Sum(CSMARTBSER.FAILS_REPORTS.MTM_EXPOSURE_USD_ABS) MTM_EXPOSURE_USD_ABS,
  CSMARTBSER.FAILS_REPORTS.COB_DATE,
   CSMARTBSER.FAILS_REPORTS.FAIL_EVENT_TYPE
,
  CSMARTBSER.FAILS_REPORTS.EXEC_TYP,
  CASE
WHEN  CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='CLU'  AND (  CSMARTBSER.FAILS_REPORTS.FAIL_EVENT_TYPE
 ) = 'TBA' then 'FAIL'
ELSE CSMARTBSER.FAILS_REPORTS.METRICS_CATEGORY
END case_FAIL_EVENT_TYPE
,
  CSMARTBSER.FAILS_REPORTS.TRANSACTION_TYPE,
  CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_0_DESC,
  CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_1_DESC,
  CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_2_DESC,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION,'UNALLOCATED') COUNTERPARTY_CLASSIFICATION,
  CSMARTBSER.FAILS_REPORTS.SDI_INSTRUCTIONS,
  CSMARTREF.REF_ESALES.CUSTOMER_TYPE_DESC,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_2_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_7_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_8_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_9_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_10_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_11_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_12_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_13_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.GOC_RGN_DESCR,
  nvl(CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT,'UNALLOCATED') FIRM_ACCOUNT,
  PEARL_FA_GOC_MAPPING.FIRM_MNEMONIC,
  PEARL_FA_GOC_MAPPING.STRAT_CODE,
  CSMARTREF.MAN_REF_SOLAR.STGY_NAM,
  nvl(CSMARTBSER.FAILS_REPORTS.DESK_NAME,'UNALLOCATED') DESK_NAME,
  CSMARTBSER.FAILS_REPORTS.TRADER_ID,
  CSMARTBSER.FAILS_REPORTS.TRADER_NAME,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_7_GRP, 'UNALLOCATED') LVL_7_GRP,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_6_GRP, 'UNALLOCATED') LVL_6_GRP,
  nvl(CASE
WHEN  CSMARTREF.MAN_REF_OPS_OWN_HIER.OWN_CD is null Then CSMARTBSER.FAILS_REPORTS.OWNERSHIP_CODE Else CSMARTBSER.FAILS_REPORTS.OWNERSHIP_CODE
END,'UNALLOCATED') case_OWNERSHIP_CODE,
  nvl(CSMARTREF.REF_ESALES.STATUS,'UNALLOCATED') CSMARTREF_STATUS,
  CASE
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND ((SUBSTR(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_CPI,1,3)='002' AND
SUBSTR(CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT,1,3)='002') OR (SUBSTR(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_CPI,1,3)='843'
AND CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT='NULL')) THEN 'INTRACOMPANY'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND SUBSTR(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_CPI,1,3)='835' THEN
'INTERCOMPANY'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION='Broker' THEN
'BROKER'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION='Client' THEN
'INSTITUTIONAL CLIENT'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION='ACATS' THEN
'RETAIL CLIENT'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_ID IN ('1144920', '1198819', '1380403', '1380404', '2165366', '2213047', '2165364', '2111252', '1984670', '1984720', '1986477', '1986478', '2025236', '2080945', '2093129', '2093134', '2105535', '2105537', '1312521', '1344187', '2199715', '2234838', '2234844', '1325227', '2260245', '2260246', '1053302', '1887574', '1887575', '1887577', '2053210', '2053217', '2053219', '2055093', '2083847', '2083852', '842315', '861079', '861609', '861618', '1260626', '1273026', '1273028', '1427757', '670425', '1072902', '1072903', '1909676', '1093755', '1170670', '1687842', '1760661', '97197', '2146307', '2322073', '2092160', '1060900', '1060998', '1061003', '1067600', '1067616', '1067642', '1067645', '1067646', '1067654', '1067655', '1067657', '1067735', '1068359', '1068376', '1068411', '1068413', '1068425', '1072955', '1072988', '1072995', '1073038', '1074407', '1074414', '1074443', '1074456', '1075775', '1094886', '1094892', '1118064', '1136765', '1158665', '1161199', '1220174', '1274179', '1282343', '1290237', '1305822', '1327147', '1340245', '1367116', '1391162', '1424962', '1433014', '1542932', '1640663', '1693207', '1699629', '1712674', '1758037', '1782532', '1782535', '1844776', '1860205', '1868974', '1937903', '2108821', '2130097', '2135605', '2141259', '2141268', '2192055', '2210124', '2212316', '2237739', '2255086', '2304971', '2400116') THEN 'EXCHANGE'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_ID IN ('1636229', '1734937', '1734939', '1734940', '1734941', '1788230', '1855694', '1860609', '1890268', '1890270', '1907836', '1932151', '2018324', '2103743', '2119617', '2126474', '2144612', '862087', '865151', '866983', '869826', '2235284', '2235285', '2235226', '2235229', '2357787', '2357796', '2033326', '2118442', '2271617', '2326394', '2328007', '2349391', '831397', '1174300', '1613174', '1828769', '1912475', '2118367', '2118400', '2207064', '2207068', '2207078', '2211641', '2275259', '2303370', '2345960', '519988', '2211113', '1672038') THEN 'Broker'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_ID IN ('1053302', '1312521', '1325227', '1344187', '1986477', '1986478', '2025236', '2080945', '2093129', '2093134', '2105535', '2105537', '2199715', '2234838', '2234844', '1310772', '1340190', '1582525', '1718059', '185345', '1942902', '1993552', '2003461', '2029435', '2032738', '2032740', '2032742', '2032744', '2139466', '2218349', '2219787', '2223049', '2224077', '2240081', '2272344', '2284454', '2297006', '2297007', '335937', '399781', '538147', '594248', '622493', '668484', '2343715', '1687542', '2213047', '2165366', '1380403', '1380404') THEN 'CLEARING HOUSE'
WHEN CSMARTREF.REF_ESALES.GP_NAME='INTERCOMPANY ACCOUNTS' OR CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE IN ('INTA','INTB',
'SBAL') OR CSMARTREF.REF_ESALES.MG_NAME='INTERCOMPANY ACCOUNTS'OR ((UPPER(CSMARTREF.REF_ESALES.MG_NAME)
LIKE 'DEPOTB%' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE 'DEPOTG%' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE 'DEPOT %' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE 'DEPOTCORP%' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE '%DEPOTBANK%')
AND CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='CUST' AND CSMARTREF.REF_ESALES.MG_NAME NOT LIKE '%ALTERNATIVE%') THEN 'INTERCOMPANY'
WHEN (((CSMARTREF.REF_ESALES.MG_NUMBER='96274' AND CSMARTREF.REF_ESALES.CUSTOMER_TYPE='00') OR
(CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='SPLT') OR (CSMARTREF.REF_ESALES.ACCOUNT_SHORT_NAME LIKE '%SUTF%' OR
CSMARTREF.REF_ESALES.ACCOUNT_SHORT_NAME LIKE '%ZTU%'))) THEN 'INSTITUTIONAL CLIENT'
WHEN CSMARTREF.REF_ESALES.ACCT_TYPE='FIRM' OR CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE IN ('INTI','SHED','DUMY','RHDG','TEST') OR
CSMARTREF.REF_ESALES.MG_NAME='OPERATIONS CONTROL ACCOUNTS' THEN 'INTRACOMPANY'
WHEN (CSMARTREF.REF_ESALES.ACCT_TYPE='BKR' AND CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='BKR') OR
CSMARTREF.REF_ESALES.ACCOUNT_ID='1672038' THEN 'BROKER'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE IN ('CUST','INST','GAVP','AAVP','PRIV','COLL','REPO','PBBK') OR
CSMARTREF.REF_ESALES.ACCOUNT_ID='97141' THEN 'INSTITUTIONAL CLIENT'
WHEN CSMARTREF.REF_ESALES.ACCT_TYPE='BKR' OR (CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='BKR' AND
CSMARTREF.REF_ESALES.ACCT_TYPE='CUST') THEN 'BROKER'
ELSE 'UNALLOCATED'
END case_1,
  nvl(CSMARTREF.REF_ESALES.ACCT_TYPE,'UNALLOCATED') ACCT_TYPE,
  CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE,
  CSMARTREF.REF_ESALES.SUB_TYPE_DESC,
  CSMARTBSER.FAILS_REPORTS.BLOTTER_CODE,
  CSMARTBSER.FAILS_REPORTS.PRODUCT_1_ID,
  CSMARTBSER.FAILS_REPORTS.PRODUCT_2_ID,
 CSMARTBSER.FAILS_REPORTS.CUSTOMER_SERVICE_LOCATION,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_NAM,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_RGN,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_LOCA,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_ID,
  nvl(CSMARTREF.REF_ESALES.ACCOUNT_ID,'UNALLOCATED') ACCOUNT_ID,
  nvl(CSMARTREF.REF_ESALES.ETC_INSTID,'UNALLOCATED') ETC_INSTID,
  CSMARTBSER.FAILS_REPORTS.MATCH_STATUS_DESCRIPTION,
  CSMARTBSER.FAILS_REPORTS.MATCH_STATUS,
  CSMARTBSER.FAILS_REPORTS.STATUS CSMARTBSER_STATUS,
  CSMARTBSER.FAILS_REPORTS.FAIL_REASON_DESCRIPTION,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_INTERNAL_CODE,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_EXTERNAL_CODE,
  CSMARTBSER.FAILS_REPORTS.TRD_STA,
  CSMARTBSER.FAILS_REPORTS.FAIL_REASON_CODE,
  CSMARTBSER.FAILS_REPORTS.NORM_FAIL_REASON_CD,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_DESCRIPTION,
  CSMARTBSER.FAILS_REPORTS.AGE_BUSINESS_DAYS,
  count(CSMARTBSER.FAILS_REPORTS.SYSTEM_ID||CSMARTBSER.FAILS_REPORTS.UNIQUE_ID) SYSTEM_ID_UNIQUE_ID,
  CSMARTBSER.FAILS_REPORTS.WOW_NEW_ITEM_IND,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_IMS,'UNALLOCATED') COUNTERPARTY_ACC_NUM_IMS,
  nvl(CSMARTREF.REF_ESALES.IMS_NUMBER,'UNALLOCATED') IMS_NUMBER,
  CSMARTBSER.FAILS_REPORTS.SETL_AGE_BUS_DAYS,
  (( CSMARTBSER.FAILS_REPORTS.COB_DATE ) - ( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ))
                -2*FLOOR((( CSMARTBSER.FAILS_REPORTS.COB_DATE )-( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ))/7)
                -DECODE(SIGN(TO_CHAR(( CSMARTBSER.FAILS_REPORTS.COB_DATE ),'D')-        TO_CHAR(( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ),'D')),-1,2,0)
              + DECODE(TO_CHAR(( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ),'D'),7,1,0)-
        DECODE(TO_CHAR(( CSMARTBSER.FAILS_REPORTS.COB_DATE ),'D'),7,1,0) calc_1,
  CSMARTBSER.FAILS_REPORTS.UNIQUE_ID,
  CSMARTBSER.FAILS_REPORTS.SOURCE_SYSTEM_OWNERSHIP_CODE,
  FAILS_COMMENTARY.DATA_BUCKET_FIELD_14406,
  FAILS_COMMENTARY.DATA_BUCKET_FIELD_14408,
  upper(FAILS_COMMENTARY.DATA_BUCKET_FIELD_16403) DATA_BUCKET_FIELD_16403,
  FAILS_COMMENTARY.DATA_BUCKET_FIELD_16404,
  nvl(CSMARTBSER.FAILS_REPORTS.SALESPERSON_ID, 'UNALLOCATED') SALESPERSON_ID,
 CSMARTBSER.FAILS_REPORTS.SALESPERSON_NAME,
  CSMARTREF.REF_SLSPRSN_HIER.SOC_CD,
  CSMARTREF.REF_SLSPRSN_HIER.SOC_CD_DESC,
  CSMARTBSER.FAILS_REPORTS.TRD_LEG,
  CSMARTBSER.FAILS_REPORTS.DK_INDICATOR,
  CSMARTBSER.FAILS_REPORTS.MTM_AVAILABLE,
  CSMARTBSER.FAILS_REPORTS.FO_TRADE_REF,
  nvl(CSMARTREF.REF_ESALES.MNEMONIC,'UNALLOCATED') MNEMONIC,
  nvl(CSMARTREF.REF_ESALES.CPI,'UNALLOCATED') CPI,
  nvl(CSMARTREF.REF_ESALES.GFCID,'UNALLOCATED' ) GFCID,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ID,'UNALLOCATED') COUNTERPARTY_ID,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM,'UNALLOCATED') COUNTERPARTY_ACC_NUM,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_PARENT_ID,'UNALLOCATED') COUNTERPARTY_PARENT_ID,
  CSMARTREF.MAN_REF_MKT_OF_SETL.CTRY_DESC,
  case when CSMARTREF.MAN_REF_MKT_OF_SETL.RGN ='' then 'UNALLOCATED' else CSMARTREF.MAN_REF_MKT_OF_SETL.RGN end case_RGN,
  CSMARTBSER.FAILS_REPORTS.COMMENTARY,
  nvl(CSMARTREF.REF_ESALES.ACCOUNT_SHORT_NAME,'UNALLOCATED') ACCOUNT_SHORT_NAME,
  SUM(CSMARTBSER.FAILS_REPORTS.QUANTITY_CONTRACTUAL) QUANTITY_CONTRACTUAL,
  CSMARTBSER.FAILS_REPORTS.DUP_IND,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_1_OWN, 'UNALLOCATED') LVL_1_OWN,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_2_OWN, 'UNALLOCATED') LVL_2_OWN,
  CSMARTBSER.FAILS_REPORTS.IRIS_VLD_STA,
  DESK_GOC_MAPPING.STRAT_CD,
  CSMARTBSER.FAILS_REPORTS.STGY_CD,
  CSMARTBSER.FAILS_REPORTS.PRE_SETL_AGE_BND_1,
  CSMARTBSER.FAILS_REPORTS.TD_AGE,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_6_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_6_CD,
  CSMARTBSER.FAILS_REPORTS.PRE_SETL_EVNT_TYP,
  CSMARTBSER.FAILS_REPORTS.PROC_COD,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_1,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_REF_1,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_2,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_REF_2,
  CSMARTBSER.FAILS_REPORTS.OBLIG_ID_CNTRL_NBR,
  CSMARTBSER.FAILS_REPORTS.PRODUCT_3_ID,
  CSMARTBSER.FAILS_REPORTS.INTERCMPY_RECON_MATCH_STA,
  CSMARTBSER.FAILS_REPORTS.INTERCMPY_MATCH_ID,
  CSMARTBSER.FAILS_REPORTS.VLD_PF,
  CSMARTBSER.FAILS_REPORTS.VLD_STA,
  CSMARTBSER.FAILS_REPORTS.VLD_OWN_CD,
  Table__284.LVL_8_GRP,
  Table__284.LVL_1_SOEID,
  Table__284.LVL_1_OWN LVL_1_OWN_284,
  Table__284.LVL_1_GRP,
  Table__284.LVL_8_OWN,
  Table__284.LVL_8_SOEID,
  Table__284.LVL_7_GRP LVL_7_GRP_284,
  Table__284.LVL_7_OWN,
  Table__284.LVL_7_SOEID,
  Table__284.LVL_6_GRP LVL_6_GRP_284,
  Table__284.LVL_6_SOEID,
  Table__284.LVL_6_OWN,
  Table__284.LVL_5_GRP,
  Table__284.LVL_5_OWN LVL_5_OWN_284,
  Table__284.LVL_5_SOEID,
  Table__284.LVL_5_LOCA LVL_5_LOCA_284,
  Table__284.LVL_4_GRP,
  Table__284.LVL_4_OWN LVL_4_OWN_284,
  Table__284.LVL_4_SOEID,
  Table__284.LVL_3_GRP LVL_3_GRP_284,
  Table__284.LVL_3_OWN LVL_3_OWN_284,
  Table__284.LVL_3_SOEID,
  Table__284.LVL_2_GRP,
  Table__284.LVL_2_OWN LVL_2_OWN_284,
  Table__284.LVL_2_SOEID,
  Table__284.LVL_2_CTRY,
  Table__284.LVL_1_CITY,
  CSMARTBSER.FAILS_REPORTS.RISK_PF_IND,
  Table__284.LVL_3_CLUS,
  CSMARTBSER.FAILS_REPORTS.SECURITY_MATURITY_DATE,
  CSMARTBSER.FAILS_REPORTS.BUYIN_DUE_DT,
  CSMARTBSER.FAILS_REPORTS.INTERNAL_PRODUCT_ID,
  CSMARTBSER.FAILS_REPORTS.INTERCO_REC_SOURCE_DUP_MTCH_ID,
  CSMARTBSER.FAILS_REPORTS.LST_ENTR_DT,
  CSMARTBSER.FAILS_REPORTS.TRD_DT_AGE_CAL_DAYS,
  CSMARTBSER.FAILS_REPORTS.TRD_DT_AGE_BAND_CAL_DAYS
FROM
  CSMARTBSER.FAILS_REPORTS partition(P20130712),
  (
  SELECT CSMARTREF. REF_MNGD_SEG_XREF.MICRO_CNTL_CD, MAX( CSMARTREF.REF_MNGD_SEG_XREF.FIRM_ACCT_MNEMONIC) AS FIRM_ACCT_MNEMONIC, CSMARTREF.REF_MNGD_SEG_XREF.GOC,  CSMARTREF.REF_MNGD_SEG_XREF.MAPNG_TRCK, TMS_REF.DESK_NAME, TMS_REF.STRAT_CD
FROM  CSMARTREF.REF_MNGD_SEG_XREF, (SELECT  CSMARTREF.MAN_REF_FIRM_TMS.TRD_AREA AS DESK_NAME, MAX( CSMARTREF.MAN_REF_FIRM_TMS.MCRCTRL_CD) AS MICROCNTLCODE, Max( CSMARTREF.MAN_REF_FIRM_TMS.STGY_CD) AS STRAT_CD
FROM  CSMARTREF.MAN_REF_FIRM_TMS
GROUP BY  CSMARTREF.MAN_REF_FIRM_TMS.TRD_AREA) TMS_REF
WHERE  CSMARTREF.REF_MNGD_SEG_XREF.MAPNG_TRCK='Track 1'AND  CSMARTREF.REF_MNGD_SEG_XREF.MICRO_CNTL_CD = TMS_REF.MICROCNTLCODE
GROUP BY  CSMARTREF.REF_MNGD_SEG_XREF.MICRO_CNTL_CD,  CSMARTREF.REF_MNGD_SEG_XREF.GOC,  CSMARTREF.REF_MNGD_SEG_XREF.MAPNG_TRCK, TMS_REF.DESK_NAME, TMS_REF.STRAT_CD
  )  DESK_GOC_MAPPING,
  CSMARTREF.REF_SLSPRSN_HIER,
  CSMARTREF.MAN_REF_OPS_OWN_HIER,
  CSMARTREF.MAN_REF_ASET_LVL_DATA,
  CSMARTREF.REF_ESALES,
  CSMARTREF.REF_MNGD_SEG_HIER,
  (
  SELECT  CSMARTREF.REF_MNGD_SEG_XREF.FIRM_ACCT AS FIRM_ACCOUNT,  CSMARTREF.REF_MNGD_SEG_XREF.FIRM_ACCT_MNEMONIC AS FIRM_MNEMONIC,  CSMARTREF.REF_MNGD_SEG_XREF.MAPNG_TRCK AS TRACK_NUMBER,  CSMARTREF.REF_MNGD_SEG_XREF.STGY_CD AS STRAT_CODE,  CSMARTREF.REF_MNGD_SEG_XREF.GOC AS GOC
FROM  CSMARTREF.REF_MNGD_SEG_XREF
WHERE  CSMARTREF.REF_MNGD_SEG_XREF.GOC IS NOT NULL AND  CSMARTREF.REF_MNGD_SEG_XREF.FIRM_ACCT IS NOT NULL AND  CSMARTREF.REF_MNGD_SEG_XREF.MAPNG_TRCK in ('Track 1','Track 2','Track 6')
  )  PEARL_FA_GOC_MAPPING,
  CSMARTREF.MAN_REF_SOLAR,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD,
  (
  SELECT  DATA_BUCKET_623.DATA_BUCKET_FIELD_14409,  DATA_BUCKET_623.DATA_BUCKET_FIELD_14406,
 DATA_BUCKET_623.DATA_BUCKET_FIELD_14408,  DATA_BUCKET_623.DATA_BUCKET_FIELD_15137,  DATA_BUCKET_623.DATA_BUCKET_FIELD_16401,  DATA_BUCKET_623.DATA_BUCKET_FIELD_16402,  DATA_BUCKET_623.DATA_BUCKET_FIELD_16403,  DATA_BUCKET_623.DATA_BUCKET_FIELD_16404
FROM  CSMARTIRIS.DATA_BUCKET_623,
(SELECT  CSMARTIRIS.DATA_BUCKET_623.DATA_BUCKET_FIELD_14409, MAX( DATA_BUCKET_623.DATA_BUCKET_FIELD_16404) AS MAX_UPDATED_TIMESTAMP FROM  CSMARTIRIS.DATA_BUCKET_623
GROUP BY  DATA_BUCKET_623.DATA_BUCKET_FIELD_14409) MAX_Qry
WHERE  DATA_BUCKET_623.DATA_BUCKET_FIELD_14409 = MAX_Qry.DATA_BUCKET_FIELD_14409 AND  DATA_BUCKET_623.DATA_BUCKET_FIELD_16404 = MAX_Qry.MAX_UPDATED_TIMESTAMP AND TRIM( DATA_BUCKET_623.DATA_BUCKET_FIELD_14409) != 'CLU'
  )  FAILS_COMMENTARY,
  CSMARTREF.MAN_REF_MKT_OF_SETL,
  CSMARTREF.MAN_REF_OPS_OWN_HIER  Table__284,
  CSMARTREF.MAN_REF_LGL_ENTY_XREF
WHERE
  ( FAILS_COMMENTARY.DATA_BUCKET_FIELD_14409(+)=CSMARTBSER.FAILS_REPORTS.UNIQUE_ID  )
  AND  ( CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT=PEARL_FA_GOC_MAPPING.FIRM_ACCOUNT(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.DESK_NAME=DESK_GOC_MAPPING.DESK_NAME(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.LGL_ENTY_KEY=CSMARTREF.MAN_REF_LGL_ENTY_XREF.LGL_ENTY_KEY(+)  )
  AND  ( CSMARTREF.MAN_REF_LGL_ENTY_XREF.LGL_ENTY_ID=CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_ID(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.ASET_CLAS_KEY=CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_KEY(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.ACTL_MKT_SETL_KEY=CSMARTREF.MAN_REF_MKT_OF_SETL.FIN_INSM_KEY(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.FO_KEY=CSMARTREF.REF_MNGD_SEG_HIER.GOC(+)  )
  AND  ( PEARL_FA_GOC_MAPPING.STRAT_CODE=    CSMARTREF.MAN_REF_SOLAR.STGY_GRP_COD(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.OWNERSHIP_CODE=CSMARTREF.MAN_REF_OPS_OWN_HIER.OWN_CD(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.SALESPERSON_ID=CSMARTREF.REF_SLSPRSN_HIER.SLSPRSN_TRDR_NO(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.NORM_FAIL_REASON_CD=CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_INTERNAL_CODE(+)  )
  AND  ( CSMARTBSER.FAILS_REPORTS.VLD_OWN_CD=Table__284.OWN_CD(+)  )
  AND  ( CSMARTREF.REF_ESALES.ACCOUNT_ID(+)=CSMARTBSER.FAILS_REPORTS.CPT_UID_GRD  )
  AND
  (
   CSMARTBSER.FAILS_REPORTS.COB_DATE  IN    ('12-JUL-13'  )
   AND
   CSMARTBSER.FAILS_REPORTS.EST_EVENT_TYPE  =  'Open Trade'
  )
GROUP BY
  CSMARTBSER.FAILS_REPORTS.VALIDATION_SOURCE,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_NAME,'UNALLOCATED'),
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_MNEMONIC,'UNALLOCATED'),
  CSMARTBSER.FAILS_REPORTS.SETTLEMENT_CURRENCY,
  CSMARTBSER.FAILS_REPORTS.TRADE_DATE,
  CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL,
  CSMARTBSER.FAILS_REPORTS.BUY_SELL,
  CSMARTBSER.FAILS_REPORTS.LEGAL_ENTITY_NAME,
  nvl(CSMARTBSER.FAILS_REPORTS.INTERNAL_PRODUCT_DESCRIPTION,'UNALLOCATED'),
  CSMARTBSER.FAILS_REPORTS.SETTLEMENT_LOCATION,
  CSMARTBSER.FAILS_REPORTS.ADDITIONAL_TRADE_REF,
  CSMARTBSER.FAILS_REPORTS.OPS_SETTLEMENT_TRADE_REF,
  CSMARTBSER.FAILS_REPORTS.OPERATIONS_TRADE_REF,
  CSMARTBSER.FAILS_REPORTS.ISIN_CODE,
  nvl(CSMARTBSER.FAILS_REPORTS.CUSIP_CODE,'UNALLOCATED'),
  CSMARTREF.REF_SLSPRSN_HIER.EMP_NAM,
  CSMARTREF.REF_SLSPRSN_HIER.SLSPRSN_TRDR_NO,
  CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM,
  CSMARTBSER.FAILS_REPORTS.AGE,
  CSMARTBSER.FAILS_REPORTS.AGE_BAND,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_5_LOCA, 'UNALLOCATED'),
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_5_OWN, 'UNALLOCATED'),
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_4_OWN, 'UNALLOCATED'),
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_3_GRP, 'UNALLOCATED'),
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_3_OWN, 'UNALLOCATED'),
   CSMARTBSER.FAILS_REPORTS.MTM_RISK,
  CSMARTBSER.FAILS_REPORTS.COB_DATE,
   CSMARTBSER.FAILS_REPORTS.FAIL_EVENT_TYPE
,
  CSMARTBSER.FAILS_REPORTS.EXEC_TYP,
  CASE
WHEN  CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='CLU'  AND (  CSMARTBSER.FAILS_REPORTS.FAIL_EVENT_TYPE
 ) = 'TBA' then 'FAIL'
ELSE CSMARTBSER.FAILS_REPORTS.METRICS_CATEGORY
END
,
  CSMARTBSER.FAILS_REPORTS.TRANSACTION_TYPE,
  CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_0_DESC,
  CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_1_DESC,
  CSMARTREF.MAN_REF_ASET_LVL_DATA.ASET_LVL_2_DESC,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION,'UNALLOCATED') ,
  CSMARTBSER.FAILS_REPORTS.SDI_INSTRUCTIONS,
  CSMARTREF.REF_ESALES.CUSTOMER_TYPE_DESC,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_2_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_7_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_8_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_9_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_10_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_11_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_12_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_13_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.GOC_RGN_DESCR,
  nvl(CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT,'UNALLOCATED') ,
  PEARL_FA_GOC_MAPPING.FIRM_MNEMONIC,
  PEARL_FA_GOC_MAPPING.STRAT_CODE,
  CSMARTREF.MAN_REF_SOLAR.STGY_NAM,
  nvl(CSMARTBSER.FAILS_REPORTS.DESK_NAME,'UNALLOCATED') ,
  CSMARTBSER.FAILS_REPORTS.TRADER_ID,
  CSMARTBSER.FAILS_REPORTS.TRADER_NAME,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_7_GRP, 'UNALLOCATED') ,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_6_GRP, 'UNALLOCATED') ,
  nvl(CASE
WHEN  CSMARTREF.MAN_REF_OPS_OWN_HIER.OWN_CD is null Then CSMARTBSER.FAILS_REPORTS.OWNERSHIP_CODE Else CSMARTBSER.FAILS_REPORTS.OWNERSHIP_CODE
END,'UNALLOCATED') ,
  nvl(CSMARTREF.REF_ESALES.STATUS,'UNALLOCATED'),
  CASE
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND ((SUBSTR(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_CPI,1,3)='002' AND
SUBSTR(CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT,1,3)='002') OR (SUBSTR(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_CPI,1,3)='843'
AND CSMARTBSER.FAILS_REPORTS.FIRM_ACCOUNT='NULL')) THEN 'INTRACOMPANY'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND SUBSTR(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_CPI,1,3)='835' THEN
'INTERCOMPANY'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION='Broker' THEN
'BROKER'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION='Client' THEN
'INSTITUTIONAL CLIENT'
WHEN CSMARTBSER.FAILS_REPORTS.SOURCESYSTEM='RADAR' AND CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_CLASSIFICATION='ACATS' THEN
'RETAIL CLIENT'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_ID IN ('1144920', '1198819', '1380403', '1380404', '2165366', '2213047', '2165364', '2111252', '1984670', '1984720', '1986477', '1986478', '2025236', '2080945', '2093129', '2093134', '2105535', '2105537', '1312521', '1344187', '2199715', '2234838', '2234844', '1325227', '2260245', '2260246', '1053302', '1887574', '1887575', '1887577', '2053210', '2053217', '2053219', '2055093', '2083847', '2083852', '842315', '861079', '861609', '861618', '1260626', '1273026', '1273028', '1427757', '670425', '1072902', '1072903', '1909676', '1093755', '1170670', '1687842', '1760661', '97197', '2146307', '2322073', '2092160', '1060900', '1060998', '1061003', '1067600', '1067616', '1067642', '1067645', '1067646', '1067654', '1067655', '1067657', '1067735', '1068359', '1068376', '1068411', '1068413', '1068425', '1072955', '1072988', '1072995', '1073038', '1074407', '1074414', '1074443', '1074456', '1075775', '1094886', '1094892', '1118064', '1136765', '1158665', '1161199', '1220174', '1274179', '1282343', '1290237', '1305822', '1327147', '1340245', '1367116', '1391162', '1424962', '1433014', '1542932', '1640663', '1693207', '1699629', '1712674', '1758037', '1782532', '1782535', '1844776', '1860205', '1868974', '1937903', '2108821', '2130097', '2135605', '2141259', '2141268', '2192055', '2210124', '2212316', '2237739', '2255086', '2304971', '2400116') THEN 'EXCHANGE'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_ID IN ('1636229', '1734937', '1734939', '1734940', '1734941', '1788230', '1855694', '1860609', '1890268', '1890270', '1907836', '1932151', '2018324', '2103743', '2119617', '2126474', '2144612', '862087', '865151', '866983', '869826', '2235284', '2235285', '2235226', '2235229', '2357787', '2357796', '2033326', '2118442', '2271617', '2326394', '2328007', '2349391', '831397', '1174300', '1613174', '1828769', '1912475', '2118367', '2118400', '2207064', '2207068', '2207078', '2211641', '2275259', '2303370', '2345960', '519988', '2211113', '1672038') THEN 'Broker'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_ID IN ('1053302', '1312521', '1325227', '1344187', '1986477', '1986478', '2025236', '2080945', '2093129', '2093134', '2105535', '2105537', '2199715', '2234838', '2234844', '1310772', '1340190', '1582525', '1718059', '185345', '1942902', '1993552', '2003461', '2029435', '2032738', '2032740', '2032742', '2032744', '2139466', '2218349', '2219787', '2223049', '2224077', '2240081', '2272344', '2284454', '2297006', '2297007', '335937', '399781', '538147', '594248', '622493', '668484', '2343715', '1687542', '2213047', '2165366', '1380403', '1380404') THEN 'CLEARING HOUSE'
WHEN CSMARTREF.REF_ESALES.GP_NAME='INTERCOMPANY ACCOUNTS' OR CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE IN ('INTA','INTB',
'SBAL') OR CSMARTREF.REF_ESALES.MG_NAME='INTERCOMPANY ACCOUNTS'OR ((UPPER(CSMARTREF.REF_ESALES.MG_NAME)
LIKE 'DEPOTB%' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE 'DEPOTG%' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE 'DEPOT %' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE 'DEPOTCORP%' OR UPPER(CSMARTREF.REF_ESALES.MG_NAME) LIKE '%DEPOTBANK%')
AND CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='CUST' AND CSMARTREF.REF_ESALES.MG_NAME NOT LIKE '%ALTERNATIVE%') THEN 'INTERCOMPANY'
WHEN (((CSMARTREF.REF_ESALES.MG_NUMBER='96274' AND CSMARTREF.REF_ESALES.CUSTOMER_TYPE='00') OR
(CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='SPLT') OR (CSMARTREF.REF_ESALES.ACCOUNT_SHORT_NAME LIKE '%SUTF%' OR
CSMARTREF.REF_ESALES.ACCOUNT_SHORT_NAME LIKE '%ZTU%'))) THEN 'INSTITUTIONAL CLIENT'
WHEN CSMARTREF.REF_ESALES.ACCT_TYPE='FIRM' OR CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE IN ('INTI','SHED','DUMY','RHDG','TEST') OR
CSMARTREF.REF_ESALES.MG_NAME='OPERATIONS CONTROL ACCOUNTS' THEN 'INTRACOMPANY'
WHEN (CSMARTREF.REF_ESALES.ACCT_TYPE='BKR' AND CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='BKR') OR
CSMARTREF.REF_ESALES.ACCOUNT_ID='1672038' THEN 'BROKER'
WHEN CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE IN ('CUST','INST','GAVP','AAVP','PRIV','COLL','REPO','PBBK') OR
CSMARTREF.REF_ESALES.ACCOUNT_ID='97141' THEN 'INSTITUTIONAL CLIENT'
WHEN CSMARTREF.REF_ESALES.ACCT_TYPE='BKR' OR (CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE='BKR' AND
CSMARTREF.REF_ESALES.ACCT_TYPE='CUST') THEN 'BROKER'
ELSE 'UNALLOCATED'
END,
  nvl(CSMARTREF.REF_ESALES.ACCT_TYPE,'UNALLOCATED'),
  CSMARTREF.REF_ESALES.ACCOUNT_SUB_TYPE,
  CSMARTREF.REF_ESALES.SUB_TYPE_DESC,
  CSMARTBSER.FAILS_REPORTS.BLOTTER_CODE,
  CSMARTBSER.FAILS_REPORTS.PRODUCT_1_ID,
  CSMARTBSER.FAILS_REPORTS.PRODUCT_2_ID,
 CSMARTBSER.FAILS_REPORTS.CUSTOMER_SERVICE_LOCATION,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_NAM,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_RGN,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_LOCA,
  CSMARTREF.MAN_REF_LGL_ENTY_DATA.LGL_ENTY_ID,
  nvl(CSMARTREF.REF_ESALES.ACCOUNT_ID,'UNALLOCATED'),
  nvl(CSMARTREF.REF_ESALES.ETC_INSTID,'UNALLOCATED'),
  CSMARTBSER.FAILS_REPORTS.MATCH_STATUS_DESCRIPTION,
  CSMARTBSER.FAILS_REPORTS.MATCH_STATUS,
  CSMARTBSER.FAILS_REPORTS.STATUS,
  CSMARTBSER.FAILS_REPORTS.FAIL_REASON_DESCRIPTION,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_INTERNAL_CODE,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_EXTERNAL_CODE,
  CSMARTBSER.FAILS_REPORTS.TRD_STA,
  CSMARTBSER.FAILS_REPORTS.FAIL_REASON_CODE,
  CSMARTBSER.FAILS_REPORTS.NORM_FAIL_REASON_CD,
  CSMARTBSER.MAN_REF_NORM_FAIL_RSN_CD.NFRC_DESCRIPTION,
  CSMARTBSER.FAILS_REPORTS.AGE_BUSINESS_DAYS,
  CSMARTBSER.FAILS_REPORTS.WOW_NEW_ITEM_IND,
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM_IMS,'UNALLOCATED'),
  nvl(CSMARTREF.REF_ESALES.IMS_NUMBER,'UNALLOCATED'),
  CSMARTBSER.FAILS_REPORTS.SETL_AGE_BUS_DAYS,
  (( CSMARTBSER.FAILS_REPORTS.COB_DATE ) - ( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ))
                -2*FLOOR((( CSMARTBSER.FAILS_REPORTS.COB_DATE )-( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ))/7)
                -DECODE(SIGN(TO_CHAR(( CSMARTBSER.FAILS_REPORTS.COB_DATE ),'D')-        TO_CHAR(( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ),'D')),-1,2,0)
              + DECODE(TO_CHAR(( CSMARTBSER.FAILS_REPORTS.SETTLEMENT_DATE_CONTRACTUAL ),'D'),7,1,0)-
        DECODE(TO_CHAR(( CSMARTBSER.FAILS_REPORTS.COB_DATE ),'D'),7,1,0),
  CSMARTBSER.FAILS_REPORTS.UNIQUE_ID,
  CSMARTBSER.FAILS_REPORTS.SOURCE_SYSTEM_OWNERSHIP_CODE,
  FAILS_COMMENTARY.DATA_BUCKET_FIELD_14406,
  FAILS_COMMENTARY.DATA_BUCKET_FIELD_14408,
  upper(FAILS_COMMENTARY.DATA_BUCKET_FIELD_16403),
  FAILS_COMMENTARY.DATA_BUCKET_FIELD_16404,
  nvl(CSMARTBSER.FAILS_REPORTS.SALESPERSON_ID, 'UNALLOCATED'),
 CSMARTBSER.FAILS_REPORTS.SALESPERSON_NAME,
  CSMARTREF.REF_SLSPRSN_HIER.SOC_CD,
  CSMARTREF.REF_SLSPRSN_HIER.SOC_CD_DESC,
  CSMARTBSER.FAILS_REPORTS.TRD_LEG,
  CSMARTBSER.FAILS_REPORTS.DK_INDICATOR,
  CSMARTBSER.FAILS_REPORTS.MTM_AVAILABLE,
  CSMARTBSER.FAILS_REPORTS.FO_TRADE_REF,
  nvl(CSMARTREF.REF_ESALES.MNEMONIC,'UNALLOCATED'),
  nvl(CSMARTREF.REF_ESALES.CPI,'UNALLOCATED'),
  nvl(CSMARTREF.REF_ESALES.GFCID,'UNALLOCATED'),
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ID,'UNALLOCATED'),
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_ACC_NUM,'UNALLOCATED'),
  nvl(CSMARTBSER.FAILS_REPORTS.COUNTERPARTY_PARENT_ID,'UNALLOCATED'),
  CSMARTREF.MAN_REF_MKT_OF_SETL.CTRY_DESC,
  case when CSMARTREF.MAN_REF_MKT_OF_SETL.RGN ='' then 'UNALLOCATED' else CSMARTREF.MAN_REF_MKT_OF_SETL.RGN end,
  CSMARTBSER.FAILS_REPORTS.COMMENTARY,
  nvl(CSMARTREF.REF_ESALES.ACCOUNT_SHORT_NAME,'UNALLOCATED'),
  CSMARTBSER.FAILS_REPORTS.DUP_IND,
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_1_OWN, 'UNALLOCATED'),
  nvl(CSMARTREF.MAN_REF_OPS_OWN_HIER.LVL_2_OWN, 'UNALLOCATED'),
  CSMARTBSER.FAILS_REPORTS.IRIS_VLD_STA,
  DESK_GOC_MAPPING.STRAT_CD,
  CSMARTBSER.FAILS_REPORTS.STGY_CD,
  CSMARTBSER.FAILS_REPORTS.PRE_SETL_AGE_BND_1,
  CSMARTBSER.FAILS_REPORTS.TD_AGE,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_6_DESCR,
  CSMARTREF.REF_MNGD_SEG_HIER.MNGD_SEG_LVL_6_CD,
  CSMARTBSER.FAILS_REPORTS.PRE_SETL_EVNT_TYP,
  CSMARTBSER.FAILS_REPORTS.PROC_COD,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_1,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_REF_1,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_2,
  CSMARTBSER.FAILS_REPORTS.AFRM_IND_REF_2,
  CSMARTBSER.FAILS_REPORTS.OBLIG_ID_CNTRL_NBR,
  CSMARTBSER.FAILS_REPORTS.PRODUCT_3_ID,
  CSMARTBSER.FAILS_REPORTS.INTERCMPY_RECON_MATCH_STA,
  CSMARTBSER.FAILS_REPORTS.INTERCMPY_MATCH_ID,
  CSMARTBSER.FAILS_REPORTS.VLD_PF,
  CSMARTBSER.FAILS_REPORTS.VLD_STA,
  CSMARTBSER.FAILS_REPORTS.VLD_OWN_CD,
  Table__284.LVL_8_GRP,
  Table__284.LVL_1_SOEID,
  Table__284.LVL_1_OWN,
  Table__284.LVL_1_GRP,
  Table__284.LVL_8_OWN,
  Table__284.LVL_8_SOEID,
  Table__284.LVL_7_GRP,
  Table__284.LVL_7_OWN,
  Table__284.LVL_7_SOEID,
  Table__284.LVL_6_GRP,
  Table__284.LVL_6_SOEID,
  Table__284.LVL_6_OWN,
  Table__284.LVL_5_GRP,
  Table__284.LVL_5_OWN,
  Table__284.LVL_5_SOEID,
  Table__284.LVL_5_LOCA,
  Table__284.LVL_4_GRP,
  Table__284.LVL_4_OWN,
  Table__284.LVL_4_SOEID,
  Table__284.LVL_3_GRP,
  Table__284.LVL_3_OWN,
  Table__284.LVL_3_SOEID,
  Table__284.LVL_2_GRP,
  Table__284.LVL_2_OWN,
  Table__284.LVL_2_SOEID,
  Table__284.LVL_2_CTRY,
  Table__284.LVL_1_CITY,
  CSMARTBSER.FAILS_REPORTS.RISK_PF_IND,
  Table__284.LVL_3_CLUS,
  CSMARTBSER.FAILS_REPORTS.SECURITY_MATURITY_DATE,
  CSMARTBSER.FAILS_REPORTS.BUYIN_DUE_DT,
  CSMARTBSER.FAILS_REPORTS.INTERNAL_PRODUCT_ID,
  CSMARTBSER.FAILS_REPORTS.INTERCO_REC_SOURCE_DUP_MTCH_ID,
  CSMARTBSER.FAILS_REPORTS.LST_ENTR_DT,
  CSMARTBSER.FAILS_REPORTS.TRD_DT_AGE_CAL_DAYS,
  CSMARTBSER.FAILS_REPORTS.TRD_DT_AGE_BAND_CAL_DAYS		
]]>
      </sql_template>
   </table_utils>
  </exec_query_copy>
  
</worker>




</etldataflow>
